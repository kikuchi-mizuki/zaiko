<!DOCTYPE html>
<html class="writer-html5" lang="ja" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="kikuchi-mizuki" /><link rel="canonical" href="https://kikuchi-mizuki.github.io/zaiko/requirements/database/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>7. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ - é«˜å³¶å±‹15åº—èˆ—å‘ã‘ è¿½åŠ ç™ºæ³¨ãƒ»åœ¨åº«ç…§ä¼šã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../stylesheets/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "7. \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u8a2d\u8a08";
        var mkdocs_page_input_path = "requirements/database.md";
        var mkdocs_page_url = "/zaiko/requirements/database/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> é«˜å³¶å±‹15åº—èˆ—å‘ã‘ è¿½åŠ ç™ºæ³¨ãƒ»åœ¨åº«ç…§ä¼šã‚·ã‚¹ãƒ†ãƒ 
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢" aria-label="ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢" title="æ¤œç´¢èªå¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">ãƒˆãƒƒãƒ—</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../proposal/">ğŸ“„ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå‘ã‘ææ¡ˆæ›¸</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">ğŸ“‹ è©³ç´°ä»•æ§˜æ›¸</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../overview/">1. æ¦‚è¦</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../system/">2. ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../users/">3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨æ¨©é™</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../workflow/">4. æ¥­å‹™ãƒ•ãƒ­ãƒ¼</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../features/">5. æ©Ÿèƒ½è¦ä»¶</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../line-ui/">6. LINE UIè¨­è¨ˆ</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">7. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#_2">ãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#stores">storesï¼ˆåº—èˆ—ãƒã‚¹ã‚¿ï¼‰</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#products">productsï¼ˆå•†å“ãƒã‚¹ã‚¿ï¼‰</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_3">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#line_usersline">line_usersï¼ˆLINEãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#invitation_codes">invitation_codesï¼ˆæ‹›å¾…ã‚³ãƒ¼ãƒ‰ï¼‰</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_4">åœ¨åº«ç®¡ç†</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#inventory">inventoryï¼ˆåœ¨åº«ï¼‰</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#inventory_sync_log">inventory_sync_logï¼ˆåœ¨åº«åŒæœŸãƒ­ã‚°ï¼‰</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_5">ç™ºæ³¨ç®¡ç†</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#requests">requestsï¼ˆè¿½åŠ ç™ºæ³¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#allocations">allocationsï¼ˆä»®å¼•å½“/ç¢ºå®šå¼•å½“ï¼‰</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_8">å‡ºè·ç®¡ç†</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#shipments">shipmentsï¼ˆå‡ºè·ï¼‰</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#documents">documentsï¼ˆå¸³ç¥¨ï¼‰</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_9">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#system_settings">system_settingsï¼ˆã‚·ã‚¹ãƒ†ãƒ è¨­å®šï¼‰</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#rlsrow-level-security">RLSï¼ˆRow Level Securityï¼‰</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_10">å‰æ</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#rls">RLSãƒãƒªã‚·ãƒ¼ä¾‹</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_11">ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_12">åˆæœŸãƒ‡ãƒ¼ã‚¿</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../excel-sync/">8. Excelåœ¨åº«åŒæœŸ</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../documents/">9. ç´å“æ›¸ç”Ÿæˆ</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../non-functional/">10. éæ©Ÿèƒ½è¦ä»¶</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../phases/">11. ãƒ•ã‚§ãƒ¼ã‚º</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../todo/">12. æœªç¢ºå®šäº‹é …</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="ãƒ¢ãƒã‚¤ãƒ«ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">é«˜å³¶å±‹15åº—èˆ—å‘ã‘ è¿½åŠ ç™ºæ³¨ãƒ»åœ¨åº«ç…§ä¼šã‚·ã‚¹ãƒ†ãƒ </a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ"></a></li>
          <li class="breadcrumb-item">ğŸ“‹ è©³ç´°ä»•æ§˜æ›¸</li>
      <li class="breadcrumb-item active">7. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/kikuchi-mizuki/zaiko/edit/master/docs/requirements/database.md">kikuchi-mizuki/zaiko ã§ç·¨é›†</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="_1">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<p>å…¨11ãƒ†ãƒ¼ãƒ–ãƒ«ã§æ§‹æˆã•ã‚Œã¾ã™ã€‚</p>
<h2 id="_2">ãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="stores">storesï¼ˆåº—èˆ—ãƒã‚¹ã‚¿ï¼‰<a class="headerlink" href="#stores" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">stores</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">gen_random_uuid</span><span class="p">(),</span>
<span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- ä¾‹: é«˜å³¶å±‹æ–°å®¿åº—</span>
<span class="w">  </span><span class="n">code</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- åº—èˆ—ã‚³ãƒ¼ãƒ‰</span>
<span class="w">  </span><span class="n">is_active</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">(),</span>
<span class="w">  </span><span class="n">updated_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">()</span>
<span class="p">);</span>
</code></pre></div>
<h3 id="products">productsï¼ˆå•†å“ãƒã‚¹ã‚¿ï¼‰<a class="headerlink" href="#products" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">gen_random_uuid</span><span class="p">(),</span>
<span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n">sku</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span><span class="w">  </span><span class="c1">-- SKUã‚³ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰</span>
<span class="w">  </span><span class="n">case_size</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- 1ã‚±ãƒ¼ã‚¹ã‚ãŸã‚Šå€‹æ•°</span>
<span class="w">  </span><span class="n">is_active</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">(),</span>
<span class="w">  </span><span class="n">updated_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">()</span>
<span class="p">);</span>
</code></pre></div>
<h2 id="_3">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="line_usersline">line_usersï¼ˆLINEãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰<a class="headerlink" href="#line_usersline" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">line_users</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">gen_random_uuid</span><span class="p">(),</span>
<span class="w">  </span><span class="n">line_user_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- LINE User ID</span>
<span class="w">  </span><span class="n">display_name</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">store_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">stores</span><span class="p">(</span><span class="n">id</span><span class="p">),</span><span class="w">  </span><span class="c1">-- store_managerã®ã¿å¿…é ˆ</span>
<span class="w">  </span><span class="k">role</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- &#39;store_manager&#39; | &#39;buyer&#39; | &#39;admin&#39;</span>
<span class="w">  </span><span class="n">supabase_auth_user_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">auth</span><span class="p">.</span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span><span class="w">  </span><span class="c1">-- å°†æ¥ã®ç´ä»˜ã‘ç”¨</span>
<span class="w">  </span><span class="n">is_active</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">(),</span>
<span class="w">  </span><span class="n">updated_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">()</span>
<span class="p">);</span>
</code></pre></div>
<p><strong>åˆ¶ç´„</strong>:
- <code>store_id</code> ã¯ <code>role='store_manager'</code> ã®å ´åˆã®ã¿å¿…é ˆ
- <code>role</code> ã¯ ENUM å‹ã‚’æ¨å¥¨</p>
<h3 id="invitation_codes">invitation_codesï¼ˆæ‹›å¾…ã‚³ãƒ¼ãƒ‰ï¼‰<a class="headerlink" href="#invitation_codes" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">invitation_codes</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">gen_random_uuid</span><span class="p">(),</span>
<span class="w">  </span><span class="n">code</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- æ‹›å¾…ã‚³ãƒ¼ãƒ‰</span>
<span class="w">  </span><span class="k">role</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- &#39;buyer&#39; | &#39;admin&#39;</span>
<span class="w">  </span><span class="n">created_by</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">auth</span><span class="p">.</span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">  </span><span class="n">used_by_line_user_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">line_users</span><span class="p">(</span><span class="n">line_user_id</span><span class="p">),</span>
<span class="w">  </span><span class="n">used_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="p">,</span>
<span class="w">  </span><span class="n">expires_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n">is_active</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">()</span>
<span class="p">);</span>
</code></pre></div>
<h2 id="_4">åœ¨åº«ç®¡ç†<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<h3 id="inventory">inventoryï¼ˆåœ¨åº«ï¼‰<a class="headerlink" href="#inventory" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">inventory</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">gen_random_uuid</span><span class="p">(),</span>
<span class="w">  </span><span class="n">product_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">products</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">  </span><span class="n">lot_no</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">expiry_date</span><span class="w"> </span><span class="nb">DATE</span><span class="p">,</span>
<span class="w">  </span><span class="n">qty_cases</span><span class="w"> </span><span class="nb">NUMERIC</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- &#39;confirmed&#39; | &#39;provisional&#39;ï¼ˆPhase1ã§ã¯å…¨ã¦provisionalï¼‰</span>
<span class="w">  </span><span class="n">updated_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">(),</span>
<span class="w">  </span><span class="k">source</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- &#39;excel_sync&#39; | &#39;admin&#39; | &#39;factory&#39;</span>
<span class="w">  </span><span class="n">note</span><span class="w"> </span><span class="nb">TEXT</span>
<span class="p">);</span>
</code></pre></div>
<p><strong>Phase1é‹ç”¨</strong>:
- å…¨ã¦ <code>status='provisional'</code> ã§é‹ç”¨
- <code>source='excel_sync'</code> ãŒåŸºæœ¬</p>
<h3 id="inventory_sync_log">inventory_sync_logï¼ˆåœ¨åº«åŒæœŸãƒ­ã‚°ï¼‰<a class="headerlink" href="#inventory_sync_log" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">inventory_sync_log</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">gen_random_uuid</span><span class="p">(),</span>
<span class="w">  </span><span class="n">sync_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">(),</span>
<span class="w">  </span><span class="n">file_last_modified</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- Excelãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—</span>
<span class="w">  </span><span class="n">file_path</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- Storageå†…ã®ãƒ‘ã‚¹</span>
<span class="w">  </span><span class="n">records_imported</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- å–ã‚Šè¾¼ã‚“ã è¡Œæ•°</span>
<span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- &#39;success&#39; | &#39;warning&#39; | &#39;failed&#39;</span>
<span class="w">  </span><span class="n">error_message</span><span class="w"> </span><span class="nb">TEXT</span>
<span class="p">);</span>
</code></pre></div>
<h2 id="_5">ç™ºæ³¨ç®¡ç†<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<h3 id="requests">requestsï¼ˆè¿½åŠ ç™ºæ³¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰<a class="headerlink" href="#requests" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">requests</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">gen_random_uuid</span><span class="p">(),</span>
<span class="w">  </span><span class="n">store_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">stores</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">  </span><span class="n">product_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">products</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">  </span><span class="n">qty_requested</span><span class="w"> </span><span class="nb">NUMERIC</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n">desired_date</span><span class="w"> </span><span class="nb">DATE</span><span class="p">,</span><span class="w">  </span><span class="c1">-- å¸Œæœ›ç´å“æ—¥ï¼ˆå‚è€ƒæƒ…å ±ï¼‰</span>
<span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- ä¸‹è¨˜ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸€è¦§å‚ç…§</span>
<span class="w">  </span><span class="n">parent_request_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">requests</span><span class="p">(</span><span class="n">id</span><span class="p">),</span><span class="w">  </span><span class="c1">-- ä¸€éƒ¨æ‰¿èªæ™‚ã®åˆ†å‰²å…ƒ</span>
<span class="w">  </span><span class="n">approved_qty</span><span class="w"> </span><span class="nb">NUMERIC</span><span class="p">,</span><span class="w">  </span><span class="c1">-- ä¸€éƒ¨æ‰¿èªæ™‚ã®å®Ÿéš›ã®æ‰¿èªæ•°é‡</span>
<span class="w">  </span><span class="n">rejected_reason</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w">  </span><span class="c1">-- å·®æˆ»ã—ç†ç”±</span>
<span class="w">  </span><span class="n">error_message</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w">  </span><span class="c1">-- ã‚¨ãƒ©ãƒ¼å†…å®¹</span>
<span class="w">  </span><span class="n">error_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="p">,</span>
<span class="w">  </span><span class="n">approved_by_line_user_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">line_users</span><span class="p">(</span><span class="n">line_user_id</span><span class="p">),</span><span class="w">  </span><span class="c1">-- LINEçµŒç”±ã®æ‰¿èª</span>
<span class="w">  </span><span class="n">approved_by_admin_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">auth</span><span class="p">.</span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span><span class="w">  </span><span class="c1">-- ç®¡ç†ç”»é¢çµŒç”±ã®æ‰¿èª</span>
<span class="w">  </span><span class="n">approved_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="p">,</span>
<span class="w">  </span><span class="n">created_by_line_user_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">line_users</span><span class="p">(</span><span class="n">line_user_id</span><span class="p">),</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">(),</span>
<span class="w">  </span><span class="n">updated_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">()</span>
<span class="p">);</span>
</code></pre></div>
<h4 id="_6">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸€è¦§<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
<th>èª¬æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pending_approval</code></td>
<td>åº—èˆ—ãŒä¾é ¼â†’æœ¬éƒ¨æ‰¿èªå¾…ã¡</td>
</tr>
<tr>
<td><code>approved</code></td>
<td>æœ¬éƒ¨æ‰¿èªæ¸ˆã¿</td>
</tr>
<tr>
<td><code>allocated_hold</code></td>
<td>ä»®å¼•å½“å®Œäº†ï¼ˆå…¨é‡ï¼‰</td>
</tr>
<tr>
<td><code>partially_confirmed</code></td>
<td>ä¸€éƒ¨ã ã‘ç¢ºå®šå¼•å½“</td>
</tr>
<tr>
<td><code>confirmed</code></td>
<td>å…¨é‡ç¢ºå®šå¼•å½“</td>
</tr>
<tr>
<td><code>shipment_requested</code></td>
<td>å‡ºè·ä¾é ¼æ¸ˆã¿</td>
</tr>
<tr>
<td><code>partially_shipped</code></td>
<td>ä¸€éƒ¨å‡ºè·å®Œäº†</td>
</tr>
<tr>
<td><code>shipped</code></td>
<td>å…¨é‡å‡ºè·å®Œäº†</td>
</tr>
<tr>
<td><code>cancelled</code></td>
<td>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</td>
</tr>
<tr>
<td><code>rejected</code></td>
<td>å·®æˆ»ã—</td>
</tr>
<tr>
<td><code>pending_inventory</code></td>
<td>åœ¨åº«å¾…ã¡ï¼ˆåˆ†å‰²ã•ã‚ŒãŸä¿ç•™åˆ†ï¼‰</td>
</tr>
</tbody>
</table>
<h4 id="_7">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»å›³<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<pre class="mermaid"><code>graph TD
    A[pending_approval] --&gt; B[approved å…¨é‡æ‰¿èª]
    A --&gt; C[approved ä¸€éƒ¨æ‰¿èª]
    A --&gt; D[rejected]
    A --&gt; E[cancelled]

    B --&gt; F[allocated_hold]
    C --&gt; F
    C --&gt; G[pending_inventory å­ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ]

    F --&gt; H[partially_confirmed]
    F --&gt; I[confirmed]

    H --&gt; J[shipment_requested]
    I --&gt; J

    J --&gt; K[partially_shipped]
    J --&gt; L[shipped]

    D --&gt; M[æ–° pending_approval ä¿®æ­£å†æå‡º]

    G --&gt; B
    G --&gt; E</code></pre>
<h3 id="allocations">allocationsï¼ˆä»®å¼•å½“/ç¢ºå®šå¼•å½“ï¼‰<a class="headerlink" href="#allocations" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">allocations</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">gen_random_uuid</span><span class="p">(),</span>
<span class="w">  </span><span class="n">request_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">requests</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">  </span><span class="n">inventory_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">inventory</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">  </span><span class="n">qty_allocated</span><span class="w"> </span><span class="nb">NUMERIC</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- &#39;hold&#39; | &#39;confirmed&#39;</span>
<span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- &#39;active&#39; | &#39;expired&#39; | &#39;released&#39; | &#39;shipped&#39;</span>
<span class="w">  </span><span class="n">expires_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="p">,</span><span class="w">  </span><span class="c1">-- holdã®ã¿ã€ä½œæˆæ™‚åˆ» + 24æ™‚é–“</span>
<span class="w">  </span><span class="n">confirmed_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="p">,</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">(),</span>
<span class="w">  </span><span class="n">updated_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">()</span>
<span class="p">);</span>
</code></pre></div>
<p><strong>é‹ç”¨ãƒ«ãƒ¼ãƒ«</strong>:</p>
<ul>
<li>æ‰¿èªæ™‚: <code>type='hold'</code>, <code>status='active'</code>, <code>expires_at=+24æ™‚é–“</code></li>
<li>æœŸé™åˆ‡ã‚Œæ™‚: <code>status='active'</code> ã®ã¾ã¾ã€è­¦å‘Šã®ã¿</li>
<li>æ‰‹å‹•è§£æ”¾: <code>status='released'</code></li>
<li>ç¢ºå®š: <code>type='confirmed'</code>, <code>confirmed_at=now()</code></li>
<li>å‡ºè·å®Œäº†: <code>status='shipped'</code></li>
</ul>
<h2 id="_8">å‡ºè·ç®¡ç†<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<h3 id="shipments">shipmentsï¼ˆå‡ºè·ï¼‰<a class="headerlink" href="#shipments" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">shipments</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">gen_random_uuid</span><span class="p">(),</span>
<span class="w">  </span><span class="n">request_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">requests</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">  </span><span class="n">ship_to_store_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">stores</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">  </span><span class="n">tracking_number</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- &#39;requested&#39; | &#39;packed&#39; | &#39;shipped&#39; | &#39;delivered&#39; | &#39;cancelled&#39;</span>
<span class="w">  </span><span class="n">shipped_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="p">,</span>
<span class="w">  </span><span class="n">delivered_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="p">,</span>
<span class="w">  </span><span class="n">note</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w">  </span><span class="c1">-- ç´å“æ—¥ã‚’æ‰‹å‹•è¨˜éŒ²ã™ã‚‹å ´åˆãªã©</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">(),</span>
<span class="w">  </span><span class="n">updated_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">()</span>
<span class="p">);</span>
</code></pre></div>
<h3 id="documents">documentsï¼ˆå¸³ç¥¨ï¼‰<a class="headerlink" href="#documents" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">documents</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">gen_random_uuid</span><span class="p">(),</span>
<span class="w">  </span><span class="n">request_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">requests</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">  </span><span class="n">doc_type</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- &#39;delivery_note&#39;</span>
<span class="w">  </span><span class="n">storage_bucket</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- &#39;documents&#39;</span>
<span class="w">  </span><span class="n">storage_path</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- ä¾‹: delivery_notes/2026/02/request_id_v1.pdf</span>
<span class="w">  </span><span class="k">version</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">  </span><span class="c1">-- 1, 2, 3...</span>
<span class="w">  </span><span class="n">is_latest</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">true</span><span class="p">,</span><span class="w">  </span><span class="c1">-- æœ€æ–°ç‰ˆãƒ•ãƒ©ã‚°</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">(),</span>
<span class="w">  </span><span class="n">created_by</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">auth</span><span class="p">.</span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>
<h2 id="_9">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h2>
<h3 id="system_settings">system_settingsï¼ˆã‚·ã‚¹ãƒ†ãƒ è¨­å®šï¼‰<a class="headerlink" href="#system_settings" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">system_settings</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">gen_random_uuid</span><span class="p">(),</span>
<span class="w">  </span><span class="k">key</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n">description</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">updated_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">()</span>
<span class="p">);</span>
</code></pre></div>
<p><strong>è¨­å®šä¾‹</strong>:</p>
<table>
<thead>
<tr>
<th>key</th>
<th>value</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>admin_notification_line_group_id</code></td>
<td><code>U1234...</code></td>
<td>ç®¡ç†è€…é€šçŸ¥å…ˆLINEã‚°ãƒ«ãƒ¼ãƒ—ID</td>
</tr>
<tr>
<td><code>inventory_storage_bucket</code></td>
<td><code>inventory</code></td>
<td>åœ¨åº«Excelä¿å­˜å…ˆbucket</td>
</tr>
<tr>
<td><code>excel_staleness_warning_hours</code></td>
<td><code>2</code></td>
<td>åœ¨åº«æƒ…å ±ã®å¤ã•è­¦å‘Šé–¾å€¤</td>
</tr>
<tr>
<td><code>allocation_hold_hours</code></td>
<td><code>24</code></td>
<td>ä»®å¼•å½“æœŸé™</td>
</tr>
</tbody>
</table>
<h2 id="rlsrow-level-security">RLSï¼ˆRow Level Securityï¼‰<a class="headerlink" href="#rlsrow-level-security" title="Permanent link">&para;</a></h2>
<h3 id="_10">å‰æ<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>LINEãƒœãƒƒãƒˆ</strong>: service role ã§å…¨ä»¶ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆRLSãƒã‚¤ãƒ‘ã‚¹ï¼‰</li>
<li><strong>ç®¡ç†ç”»é¢</strong>: Supabase Auth + RLS ã§åˆ¶å¾¡</li>
</ul>
<h3 id="rls">RLSãƒãƒªã‚·ãƒ¼ä¾‹<a class="headerlink" href="#rls" title="Permanent link">&para;</a></h3>
<h4 id="requests_1">requests ãƒ†ãƒ¼ãƒ–ãƒ«<a class="headerlink" href="#requests_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">-- åº—èˆ—ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼: è‡ªåº—èˆ—ã®ã¿é–²è¦§</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="ss">&quot;store_manager_select_own&quot;</span>
<span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">requests</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">SELECT</span>
<span class="w">  </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">line_users</span>
<span class="w">      </span><span class="k">WHERE</span><span class="w"> </span><span class="n">line_users</span><span class="p">.</span><span class="n">supabase_auth_user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">auth</span><span class="p">.</span><span class="n">uid</span><span class="p">()</span>
<span class="w">        </span><span class="k">AND</span><span class="w"> </span><span class="n">line_users</span><span class="p">.</span><span class="k">role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;store_manager&#39;</span>
<span class="w">        </span><span class="k">AND</span><span class="w"> </span><span class="n">requests</span><span class="p">.</span><span class="n">store_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">line_users</span><span class="p">.</span><span class="n">store_id</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>

<span class="c1">-- æœ¬éƒ¨ãƒã‚¤ãƒ¤ãƒ¼ãƒ»ç®¡ç†è€…: å…¨ä»¶é–²è¦§</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="ss">&quot;buyer_admin_select_all&quot;</span>
<span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">requests</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">SELECT</span>
<span class="w">  </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">line_users</span>
<span class="w">      </span><span class="k">WHERE</span><span class="w"> </span><span class="n">line_users</span><span class="p">.</span><span class="n">supabase_auth_user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">auth</span><span class="p">.</span><span class="n">uid</span><span class="p">()</span>
<span class="w">        </span><span class="k">AND</span><span class="w"> </span><span class="n">line_users</span><span class="p">.</span><span class="k">role</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;buyer&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>
</code></pre></div>
<h4 id="inventory_1">inventory ãƒ†ãƒ¼ãƒ–ãƒ«<a class="headerlink" href="#inventory_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">-- æœ¬éƒ¨ãƒã‚¤ãƒ¤ãƒ¼ãƒ»ç®¡ç†è€…ã®ã¿é–²è¦§å¯</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="ss">&quot;buyer_admin_select_inventory&quot;</span>
<span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">inventory</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">SELECT</span>
<span class="w">  </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">line_users</span>
<span class="w">      </span><span class="k">WHERE</span><span class="w"> </span><span class="n">line_users</span><span class="p">.</span><span class="n">supabase_auth_user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">auth</span><span class="p">.</span><span class="n">uid</span><span class="p">()</span>
<span class="w">        </span><span class="k">AND</span><span class="w"> </span><span class="n">line_users</span><span class="p">.</span><span class="k">role</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;buyer&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>
</code></pre></div>
<h2 id="_11">ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h2>
<p>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã®ãŸã‚ã€ä»¥ä¸‹ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆï¼š</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- requests</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_requests_status</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">requests</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_requests_store_id</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">requests</span><span class="p">(</span><span class="n">store_id</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_requests_created_at</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">requests</span><span class="p">(</span><span class="n">created_at</span><span class="p">);</span>

<span class="c1">-- allocations</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_allocations_request_id</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">allocations</span><span class="p">(</span><span class="n">request_id</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_allocations_expires_at</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">allocations</span><span class="p">(</span><span class="n">expires_at</span><span class="p">)</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;hold&#39;</span><span class="p">;</span>

<span class="c1">-- inventory</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_inventory_product_id</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">inventory</span><span class="p">(</span><span class="n">product_id</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_inventory_status</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">inventory</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
</code></pre></div>
<h2 id="_12">åˆæœŸãƒ‡ãƒ¼ã‚¿<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h2>
<p>Phase1é–‹å§‹å‰ã«ä»¥ä¸‹ã®ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ãŒå¿…è¦ï¼š</p>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> storesï¼ˆ15åº—èˆ—ï¼‰</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> productsï¼ˆå•†å“ä¸€è¦§ï¼‰</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> system_settingsï¼ˆåŸºæœ¬è¨­å®šï¼‰</li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³">
        <a href="../line-ui/" class="btn btn-neutral float-left" title="6. LINE UIè¨­è¨ˆ"><span class="icon icon-circle-arrow-left"></span> å‰ã¸</a>
        <a href="../excel-sync/" class="btn btn-neutral float-right" title="8. Excelåœ¨åº«åŒæœŸ">æ¬¡ã¸ <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  <a href="https://readthedocs.org">Read the Docs</a> æä¾›ã® <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> ã‚’ä½¿ã£ã¦ <a href="https://www.mkdocs.org/">MkDocs</a> ã§ãƒ“ãƒ«ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="ãƒãƒ¼ã‚¸ãƒ§ãƒ³">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/kikuchi-mizuki/zaiko" class="fa fa-code-fork" style="color: #fcfcfc"> kikuchi-mizuki/zaiko</a>
        </span>
    
    
      <span><a href="../line-ui/" style="color: #fcfcfc">&laquo; å‰ã¸</a></span>
    
    
      <span><a href="../excel-sync/" style="color: #fcfcfc">æ¬¡ã¸ &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
