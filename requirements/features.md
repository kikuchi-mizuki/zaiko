# 機能要件

## 在庫照会

### 概要
店舗がLINEで商品の在庫数量をリアルタイムで確認できる機能。

### 機能詳細
- 商品選択（クイックリプライ）
- リアルタイム在庫数量表示
- Excel同期タイムスタンプ表示（「※○時間前の情報」）
- **納品日は表示しない**（別途連絡）

### 返答例
```
【在庫照会結果】
商品: 生チョコレート
在庫: 10ケース
※この情報は2時間前のものです

納品日は別途ご連絡します。
```

---

## 追加発注

### 概要
店舗がLINEから追加発注を依頼できる機能。

### 機能詳細
- 商品選択（クイックリプライ）
- 数量入力（ケース単位、整数のみ）
- 希望納品日入力（任意、参考情報として記録）
- 確認画面表示
- 依頼完了通知

### バリデーション
- 数量: 整数のみ（小数点不可）
- 単位: ケース単位のみ

---

## 本部承認

### 概要
本部バイヤーが発注依頼を承認・差戻し・一部承認できる機能。

### 承認待ち一覧
- 希望納品日の早い順で表示（緊急度優先）
- 在庫状況も同時に表示
- LINE/管理画面の両方から操作可能

### 承認パターン

#### 全量承認
1. 全量を承認
2. 自動で在庫引当（allocations 作成）
3. `status: approved → allocated_hold`

#### 一部承認
1. 承認数量を入力（例: 依頼10ケース → 承認7ケース）
2. 元リクエストを承認数量で更新（`qty_requested: 10 → 7`）
3. 残り数量で新規リクエスト作成
   - `parent_request_id` で紐付け
   - `status: pending_inventory`
4. 店舗に通知
   - 「7ケース承認、残り3ケースは在庫確保でき次第連絡」

#### 差戻し
1. 理由入力
2. 店舗に通知（status: `rejected`）
3. 店舗が修正して再提出可能

---

## 在庫引当管理

### 概要
承認された発注に対して在庫を仮引当・確定する機能。

### 仮引当（hold）
- 承認時に自動で作成
- `type='hold'`, `status='active'`
- `expires_at = 作成時刻 + 24時間`
- 複数在庫からの引当可能（1 request → 複数 allocations）

### 確定引当（confirmed）
- 仮引当から確定に変更
- `type='confirmed'`, `confirmed_at=now()`
- 部分確定可能（一部だけ confirmed に変更）

### 期限管理
- 期限切れ警告（自動解放はしない）
- 管理画面の「期限切れ一覧」に表示
- 店舗にLINE通知

### 手動操作（管理画面）
- 期限延長
- 手動解放（`status='released'`）
- 確定（`type='confirmed'`）

---

## 出荷依頼

### 概要
承認後、自動で出荷依頼を生成し、加工会社に通知する機能。

### 処理フロー
1. 承認完了
2. 自動で `shipment_requested` に遷移
3. 納品書PDF自動生成（既存フォーマット踏襲）
4. Supabase Storageに保存
5. 加工会社への通知（方法は後日確定）

### バージョン管理
- 修正時は新バージョン作成
- `documents.version` をインクリメント
- `is_latest` フラグで最新版を管理

---

## Excel在庫同期

### 概要
管理画面からExcelをアップロードし、5分毎に自動同期する機能。

### アップロードフロー
1. 管理画面で「Excelアップロード」ボタン
2. Supabase Storage (`inventory` bucket) に保存
   - ファイル名: `inventory_YYYYMMDD_HHMMSS.xlsx`
3. 「同期実行」ボタンまたは自動トリガー

### 自動同期（Cron: 5分毎）
1. 最新ファイルを読み込み
2. ファイル更新タイムスタンプを記録
3. Python (pandas) で解析
4. products照合（商品名でマッチ）
5. inventory へ UPSERT
   - `status='provisional'`
   - `source='excel_sync'`
6. 同期結果を `inventory_sync_log` に記録

### エラー処理
- 同期失敗時: 管理者LINEグループに通知
- 通知内容: エラー内容、ファイル名、タイムスタンプ

---

## 依頼状況確認

### 概要
店舗/本部が発注依頼の状況を確認できる機能。

### 店舗マネージャー
- 自店舗の依頼一覧
- ステータス・依頼日・出荷日表示

### 本部バイヤー
- 全店舗の依頼一覧
- フィルタ・ソート機能

### 詳細表示
- リクエスト詳細
- 在庫引当状況
- 出荷情報
- 納品書ダウンロードリンク（出荷後）
