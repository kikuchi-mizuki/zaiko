# ============================================
# 要件定義書（更新版）
# 高島屋15店舗向け 追加発注・在庫照会・出荷依頼 自動化システム
# Version: 1.0（壁打ち反映版）
# 更新日: 2026-02-15
# ============================================

## 変更履歴
- v0.2: 初版（暫定）
- v1.0: 壁打ちを通じた詳細確定版
  - LINE認証とユーザー管理の詳細化
  - allocations/requestsのステータス管理強化
  - 一部承認（自動分割）機能追加
  - 温度帯管理削除
  - 納品日自動計算削除（在庫照会のみに特化）
  - Excel同期方式明確化（Supabase Storage経由）

---

## 1. 目的
繁忙期における高島屋15店舗からの突発的な追加発注対応を効率化し、以下を実現する。

- 店舗がLINEで即時に在庫可否を確認できる（納品日は別途連絡）
- 本部・貴社・加工会社間の伝言ゲームを削減する
- 在庫の確度（confirmed/provisional）を管理し事故を防ぐ
- 出荷依頼・納品書生成を自動化する
- 一部承認時は自動でリクエスト分割し、在庫待ちを管理する
- **Phase1方針**: 精度より運用の回りやすさを優先（暫定運用OK）

---

## 2. システム構成
- **フロント**: LINE Official Account（Messaging API）
- **バックエンド**: Python（FastAPI想定）
- **DB**: Supabase（PostgreSQL + RLS）
- **認証**:
  - LINE: LINE User ID ベース（`line_users` テーブル）
  - 管理画面: Supabase Auth（Email + Password）
- **ファイル**: Supabase Storage
  - 納品書PDF: `documents` bucket
  - 在庫Excel: `inventory` bucket
- **ジョブ**: Supabase Cron（または外部cron）で以下を実行
  - Excel同期（5分毎）
  - 仮引当期限チェック（1時間毎）
- **在庫入力元**: Excel（Phase1: 手動アップロード）
- **帳票**: PDF自動生成（reportlab or openpyxl想定）

---

## 3. 対象ユーザーと権限

### 3.1 店舗マネージャー
- 自店舗の追加発注依頼
- 自店舗の依頼状況確認
- 在庫照会（数量のみ。納品日は別途連絡）
- **登録方法**: LINE友だち追加 → 店舗選択 → 自動登録

### 3.2 本部バイヤー
- 全店舗の発注承認/差戻し/一部承認
- 全依頼状況の確認
- **操作環境**: 管理画面（PC）とLINE（モバイル）の両方
- **登録方法**: 招待コード入力 → 自動登録

### 3.3 貴社管理者（運用管理）
- 全データ閲覧・修正
- 在庫Excel アップロード
- 暫定在庫使用時の承認
- 仮引当の手動解放・期限延長
- 強制確定/取消

### 3.4 加工会社（Phase1では最低限）
- 出荷依頼の受領（通知方法は後日確定）
- 出荷ステータス更新（shipped + tracking）

---

## 4. To-Be 業務フロー

### 4.1 追加発注（店舗 → 本部）

**店舗側（LINE）**:
1. [在庫照会] または [追加発注] をタップ
2. 商品選択（クイックリプライで選択）
3. 数量入力（ケース単位のみ、整数）
4. 希望納品日選択（できるだけ早く / 日付指定 / 特になし）
5. 確認画面で [はい]
6. システムが受付（status: `pending_approval`）

**本部側（LINE or 管理画面）**:
7. 承認依頼通知を受信（希望納品日順でソート）
8. 在庫を確認して以下のいずれかを選択:
   - **全量承認**: → `approved` → 自動で在庫引当（`allocated_hold`）
   - **一部承認**: 承認数量を入力 → 元リクエストは承認数量で確定、残りは新規リクエスト（`pending_inventory`）として自動作成
   - **差戻し**: 理由入力 → 店舗に通知（status: `rejected`）

### 4.2 在庫照会（店舗 → システム）

**店舗側（LINE）**:
1. [在庫照会] をタップ
2. 商品選択
3. システムが在庫数量を回答:
   ```
   【在庫照会結果】
   商品: ○○
   在庫: 10ケース
   ※この情報は2時間前のものです

   納品日は別途ご連絡します。
   ```

### 4.3 出荷依頼（本部 → 加工会社）

1. 本部承認 → `shipment_requested` に自動遷移
2. 納品書PDF自動生成 → Supabase Storage保存
3. 加工会社に通知（通知方法は後日確定）
4. 加工会社が出荷完了報告 → `shipped`

### 4.4 仮引当期限切れ

1. Cron（1時間毎）が `allocations.expires_at` をチェック
2. 期限切れ発見時:
   - 店舗マネージャーにLINE通知（「まだ必要ですか？」）
   - 管理画面の「期限切れ一覧」に表示
   - **自動解放はしない**（Phase1では手動対応）

---

## 5. 機能要件

### 5.1 在庫照会
- 商品選択（クイックリプライ）
- リアルタイム在庫数量表示
- Excel同期タイムスタンプ表示（「※○時間前の情報」）
- 納品日は表示しない（別途連絡）

### 5.2 追加発注
- 商品選択（クイックリプライ）
- 数量入力（ケース単位、整数のみ）
- 希望納品日入力（任意、参考情報として記録）
- 確認画面表示
- 依頼完了通知

### 5.3 本部承認
- 承認待ち一覧（希望納品日の早い順）
- 在庫状況表示
- **全量承認**: 全量を承認 → 自動で在庫引当
- **一部承認**:
  - 承認数量を入力（例: 依頼10ケース → 承認7ケース）
  - 元リクエストを承認数量で更新（`qty_requested: 10 → 7`）
  - 残り数量で新規リクエスト作成（`parent_request_id` で紐付け、`status: pending_inventory`）
  - 店舗に通知（「7ケース承認、残り3ケースは在庫確保でき次第連絡」）
- **差戻し**: 理由入力 → 店舗に通知（status: `rejected`）
- LINE/管理画面の両方から操作可能

### 5.4 在庫引当管理
- 承認時に自動で仮引当（`allocations` 作成、`type='hold'`, `expires_at=+24時間`）
- 複数在庫からの引当可能（1 request → 複数 allocations）
- 部分確定可能（一部だけ `type='confirmed'` に変更）
- 期限切れ警告（自動解放はしない）
- 手動解放・期限延長（管理画面）

### 5.5 出荷依頼
- 承認後、自動で `shipment_requested` に遷移
- 納品書PDF自動生成（既存フォーマット踏襲、詳細は後日確定）
- バージョン管理（修正時は新バージョン作成）
- 加工会社への通知（方法は後日確定）

### 5.6 Excel在庫同期
- 管理画面からExcelアップロード → Supabase Storage保存
- 5分毎に自動同期（Cron）
- ファイル更新タイムスタンプを記録
- 全行を `status='provisional'` として取り込み（Phase1）
- 同期結果を `inventory_sync_log` に記録
- エラー時は管理者LINEグループに通知

### 5.7 依頼状況確認
- 店舗: 自店舗の依頼一覧
- 本部: 全店舗の依頼一覧
- ステータス・依頼日・出荷日表示
- 詳細表示機能

---

## 6. LINE UI 設計

### 6.1 リッチメニュー

**店舗マネージャー向け**:
```
+----------------+----------------+
|   在庫照会      |   追加発注     |
+----------------+----------------+
|  依頼状況確認   |   ヘルプ      |
+----------------+----------------+
```

**本部バイヤー向け**:
```
+----------------+----------------+
|  承認待ち一覧   |  全依頼確認    |
+----------------+----------------+
|  管理画面へ     |   ヘルプ      |
+----------------+----------------+
```

### 6.2 主要フロー

#### 在庫照会フロー
```
店舗: [在庫照会] タップ
BOT: 商品を選択してください [クイックリプライ: 商品一覧]
店舗: [生チョコレート] 選択
BOT: 【在庫照会結果】
     商品: 生チョコレート
     在庫: 10ケース
     ※この情報は2時間前のものです

     納品日は別途ご連絡します。
```

#### 追加発注フロー
```
店舗: [追加発注] タップ
BOT: 商品を選択してください [クイックリプライ]
店舗: [生チョコレート] 選択
BOT: 数量（ケース数）を入力してください
店舗: 「10」と入力
BOT: 希望納品日はありますか？
     [できるだけ早く] [日付を指定] [特になし]
店舗: [できるだけ早く] 選択
BOT: 【確認】
     商品: 生チョコレート
     数量: 10ケース
     希望: できるだけ早く

     この内容で発注依頼しますか？
     [はい] [いいえ]
店舗: [はい]
BOT: 発注依頼を受け付けました。
     本部承認後、詳細をご連絡します。
```

#### 本部承認フロー（LINE）
```
BOT → 本部: 【承認依頼】
           店舗: 高島屋新宿店
           商品: 生チョコレート
           数量: 10ケース
           希望日: できるだけ早く

           在庫: 10ケース（※2時間前）

           [全量承認] [一部承認] [差戻し]

本部: [一部承認] タップ
BOT: 承認する数量を入力してください
本部: 「7」と入力
BOT: 【確認】
     依頼数量: 10ケース
     承認数量: 7ケース
     保留数量: 3ケース

     7ケースを承認し、残り3ケースは在庫待ちとして登録します。
     よろしいですか？
     [はい] [いいえ]
本部: [はい]
BOT: 承認しました。
     店舗に通知し、出荷依頼を送信しました。

↓ 同時に店舗へ通知

BOT → 店舗: 【一部承認】
           依頼数量: 10ケース
           承認数量: 7ケース
           保留数量: 3ケース

           7ケースは出荷手続きを進めます。
           残り3ケースは在庫が確保でき次第、別途ご連絡します。

           [了解] [残り3ケースをキャンセル]
```

---

## 7. データベース設計

### 7.1 stores（店舗マスタ）
```sql
- id (uuid, PK)
- name (text)  # 例: 高島屋新宿店
- code (text, unique)  # 店舗コード
- is_active (bool)
- created_at, updated_at
```

### 7.2 line_users（LINEユーザー）
```sql
- id (uuid, PK)
- line_user_id (text, unique)  # LINE User ID
- display_name (text)
- store_id (uuid, FK->stores.id, nullable)  # store_managerのみ必須
- role (text)  # 'store_manager' | 'buyer' | 'admin'
- supabase_auth_user_id (uuid, FK->auth.users.id, nullable)  # 将来の紐付け用
- is_active (bool)
- created_at, updated_at
```

### 7.3 invitation_codes（招待コード）
```sql
- id (uuid, PK)
- code (text, unique)  # 招待コード
- role (text)  # 'buyer' | 'admin'
- created_by (uuid, FK->auth.users.id)
- used_by_line_user_id (text, FK->line_users.line_user_id, nullable)
- used_at (timestamptz, nullable)
- expires_at (timestamptz)
- is_active (bool)
- created_at
```

### 7.4 products（商品マスタ）
```sql
- id (uuid, PK)
- name (text)
- sku (text, unique, nullable)
- case_size (int)  # 1ケースあたり個数
- is_active (bool)
- created_at, updated_at
```

### 7.5 inventory（在庫）
```sql
- id (uuid, PK)
- product_id (uuid, FK->products.id)
- lot_no (text, nullable)
- expiry_date (date, nullable)
- qty_cases (numeric)
- status (text)  # 'confirmed' | 'provisional'（Phase1では全てprovisional）
- updated_at (timestamptz)
- source (text)  # 'excel_sync' | 'admin' | 'factory'
- note (text, nullable)
```

### 7.6 requests（追加発注リクエスト）
```sql
- id (uuid, PK)
- store_id (uuid, FK->stores.id)
- product_id (uuid, FK->products.id)
- qty_requested (numeric)
- desired_date (date, nullable)  # 希望納品日（参考情報）
- status (text)
  # pending_approval    店舗が依頼→本部承認待ち
  # approved            本部承認済み
  # allocated_hold      仮引当完了（全量）
  # partially_confirmed 一部だけ確定引当
  # confirmed           全量確定引当
  # shipment_requested  出荷依頼済み
  # partially_shipped   一部出荷完了
  # shipped             全量出荷完了
  # cancelled           キャンセル
  # rejected            差戻し
  # pending_inventory   在庫待ち（分割された保留分）
- parent_request_id (uuid, FK->requests.id, nullable)  # 一部承認時の分割元
- approved_qty (numeric, nullable)  # 一部承認時の実際の承認数量
- rejected_reason (text, nullable)  # 差戻し理由
- error_message (text, nullable)  # エラー内容
- error_at (timestamptz, nullable)
- approved_by_line_user_id (text, nullable)  # LINE経由の承認
- approved_by_admin_id (uuid, nullable)  # 管理画面経由の承認
- approved_at (timestamptz, nullable)
- created_by_line_user_id (text, nullable)
- created_at, updated_at
```

**ステータス遷移図**:
```
pending_approval
  ├→ approved（全量承認）→ allocated_hold → partially_confirmed / confirmed
  │   └→ shipment_requested → partially_shipped / shipped
  ├→ approved（一部承認）→ allocated_hold
  │   └→ 自動的に pending_inventory の子リクエスト作成
  ├→ rejected（差戻し）
  │   └→ 店舗が修正再提出 → 新 pending_approval
  └→ cancelled

pending_inventory（在庫待ち）
  ├→ approved（在庫確保できた）→ allocated_hold → ...
  └→ cancelled

※ shipment_requested 以前ならいつでも cancelled 可能
```

### 7.7 allocations（仮引当/確定引当）
```sql
- id (uuid, PK)
- request_id (uuid, FK->requests.id)
- inventory_id (uuid, FK->inventory.id)
- qty_allocated (numeric)
- type (text)  # 'hold' | 'confirmed'
- status (text)  # 'active' | 'expired' | 'released' | 'shipped'
- expires_at (timestamptz, nullable)  # holdのみ、作成時刻 + 24時間
- confirmed_at (timestamptz, nullable)
- created_at, updated_at
```

**運用ルール**:
- 承認時に `type='hold'`, `status='active'`, `expires_at=+24時間` で作成
- 期限切れ時: `status='active'` のまま、管理画面に警告表示 + 店舗にLINE通知
- 手動解放: `status='released'`
- 確定: `type='confirmed'`, `confirmed_at=now()`
- 出荷完了: `status='shipped'`

### 7.8 shipments（出荷）
```sql
- id (uuid, PK)
- request_id (uuid, FK->requests.id)
- ship_to_store_id (uuid, FK->stores.id)
- tracking_number (text, nullable)
- status (text)  # 'requested' | 'packed' | 'shipped' | 'delivered' | 'cancelled'
- shipped_at (timestamptz, nullable)
- delivered_at (timestamptz, nullable)
- note (text, nullable)  # 納品日を手動記録する場合など
- created_at, updated_at
```

### 7.9 documents（帳票）
```sql
- id (uuid, PK)
- request_id (uuid, FK->requests.id)
- doc_type (text)  # 'delivery_note'
- storage_bucket (text)  # 'documents'
- storage_path (text)  # 例: delivery_notes/2026/02/request_id_v1.pdf
- version (int)  # 1, 2, 3...
- is_latest (bool)  # 最新版フラグ
- created_at
- created_by (uuid, nullable)
```

### 7.10 system_settings（システム設定）
```sql
- id (uuid, PK)
- key (text, unique)
  # 'admin_notification_line_group_id'  管理者通知先LINEグループID
  # 'inventory_storage_bucket'          在庫Excel保存先bucket
  # 'excel_staleness_warning_hours'     在庫情報の古さ警告閾値（デフォルト: 2）
  # 'allocation_hold_hours'             仮引当期限（デフォルト: 24）
- value (text)
- description (text)
- updated_at
```

### 7.11 inventory_sync_log（在庫同期ログ）
```sql
- id (uuid, PK)
- sync_at (timestamptz)  # 同期実行時刻
- file_last_modified (timestamptz)  # Excelファイルの更新タイムスタンプ
- file_path (text)  # Storage内のパス
- records_imported (int)  # 取り込んだ行数
- status (text)  # 'success' | 'warning' | 'failed'
- error_message (text, nullable)
```

---

## 8. RLS（アクセス制御）要件

### 8.1 前提
- **LINEボット**: Backend（FastAPI）が Supabase の service role で全件アクセス
- **管理画面**: Supabase Auth + RLS で制御

### 8.2 RLSルール（管理画面用）
- **store_manager**: 自店舗の requests のみ閲覧
- **buyer/admin**: 全件閲覧・更新可
- **inventory**: buyer/admin のみ閲覧・更新可

---

## 9. Excel在庫読み込み仕様

### 9.1 想定Excel列（後日確定）
- 商品名
- ケース数
- 賞味期限（任意）
- ロット番号（任意）
- 備考（任意）

### 9.2 保存場所・同期方式
- **Phase1**: 管理画面からExcelアップロード → Supabase Storage (`inventory` bucket) に保存
- ファイル名: `inventory_YYYYMMDD_HHMMSS.xlsx`（履歴管理）
- 5分毎に最新ファイルを自動同期（Supabase Cron）
- Python (pandas) で読み込み → products照合 → inventory へ UPSERT
- `source='excel_sync'`, `status='provisional'` で統一（Phase1）

### 9.3 商品名→product_id照合
- products.name をキーにマッチ（完全一致、後日詳細確定）
- マッチしない商品名は `inventory_sync_log.error_message` に記録（Phase2で専用テーブル検討）

### 9.4 エラー通知
- 同期失敗時: 管理者LINEグループに通知
- 通知内容: エラー内容、ファイル名、タイムスタンプ

---

## 10. 納品書生成仕様

### 10.1 既存フォーマット（後日確定）
- 既存のExcel/PDFテンプレートを踏襲
- 必須項目: 後日確定（商品名、数量、ロット番号、賞味期限など）
- 単価・金額の表示要否: 後日確定

### 10.2 生成タイミング
- `status = 'shipment_requested'` になったタイミング（出荷依頼時）

### 10.3 保存先
- Supabase Storage bucket: `documents`
- パス: `delivery_notes/{YYYY}/{MM}/{request_id}_v{version}.pdf`

### 10.4 再生成
- 数量修正・再送時は新バージョンとして生成
- `documents.version` をインクリメント
- `is_latest` フラグで最新版を管理

### 10.5 実装方法（後日詳細確定）
- reportlab or openpyxl でPDF生成
- 既存テンプレートの形式に応じて選択

---

## 11. 非機能要件

### 11.1 監査ログ
- 誰が承認/差戻/取消したか（`requests.approved_by_*` で記録）
- 在庫同期履歴（`inventory_sync_log`）
- 納品書生成履歴（`documents`）

### 11.2 エラー通知
- 同期失敗・PDF生成失敗時: 管理者LINEグループに通知
- 在庫引当失敗時: `requests.error_message` に記録

### 11.3 バックアップ
- Supabase標準バックアップ + 定期export（運用方針は後で確定）

### 11.4 同時アクセス
- 繁忙期でもLINE問い合わせが詰まらない（APIは軽量に）
- 同一在庫への同時引当: トランザクション制御で排他処理

### 11.5 パフォーマンス
- 在庫照会: 3秒以内にレスポンス
- 追加発注: 5秒以内に受付完了通知

---

## 12. フェーズ

### Phase1（MVP）
- ✅ 追加発注（LINE）
- ✅ 在庫照会（数量のみ、納品日は別途連絡）
- ✅ 本部承認（全量/一部/差戻し）
- ✅ 一部承認時の自動分割
- ✅ 仮引当管理（24時間期限、警告のみ）
- ✅ 出荷依頼通知
- ✅ 納品書PDF生成 → Supabase Storage保存
- ✅ Excel手動アップロード + 自動同期
- ✅ requests/shipments/allocations ステータス管理
- ✅ LINE UI（リッチメニュー、クイックリプライ）

### Phase2（精度向上）
- 仮引当期限切れ自動解除
- 商品名照合ミスのエラー管理強化
- 納品一覧（view + CSV export or Sheets連携）
- Excel自動アップロード（Googleドライブ連携など）
- 在庫 status='confirmed' 管理の本格運用

### Phase3（最適化）
- ロット/賞味期限最適化（FIFO）
- 納品日精度改善（祝日カレンダー、店舗受入条件）
- 本部承認の条件付き自動化（金額/数量閾値）

---

## 13. 未確定事項（Phase1実装前に要確認）

### 優先度: 高（実装に必須）

#### 13.1 Excel関連
- [ ] Excel列構成の確定
- [ ] 現在のExcel保存場所の確認
- [ ] 商品名→product_id の照合ルール詳細

#### 13.2 納品書関連
- [ ] 既存テンプレートファイルの入手
- [ ] 必須項目の確定
- [ ] 単価・金額の表示要否

#### 13.3 マスタデータ
- [ ] 商品マスタの初期データ（商品数、SKU、単価など）
- [ ] 店舗マスタの初期データ（15店舗の一覧、コード）

### 優先度: 中（仮決めで進行可能）

#### 13.4 通知関連
- [ ] 管理者LINEグループの作成
- [ ] 加工会社への出荷依頼通知方法（LINE/メール/管理画面）

#### 13.5 権限・セキュリティ
- [ ] 店舗マネージャー登録時の認証方法（誰でも登録可能で良いか）
- [ ] 本部バイヤーの招待コード管理フロー

#### 13.6 加工会社の運用
- [ ] 出荷完了報告の入力方法（tracking番号入力フロー）

### 優先度: 低（Phase2以降）
- [ ] 納品一覧の出力形式・タイミング
- [ ] ロット/賞味期限のFIFOルール
- [ ] 納品日自動計算ロジック

---

## 14. 補足: 主要な変更点（v0.2 → v1.0）

### 追加機能
- 一部承認（自動分割）機能
- 仮引当期限管理（24時間、警告のみ）
- Excel手動アップロード（Supabase Storage経由）
- 招待コード方式でのユーザー登録
- LINE UI の詳細設計（リッチメニュー、フロー）
- エラーログ管理（`error_message`, `error_at` フィールド）

### 削除機能
- 温度帯管理（`products.temperature_type`）
- 納品日自動計算ロジック
- draft ステータス

### 設計変更
- `allocations` に `status` フィールド追加（type と status の二軸管理）
- `requests.status` の拡張（rejected, pending_inventory 追加）
- `line_users.role` で全ユーザー種別を管理
- `documents` にバージョン管理追加
- 納品日は「在庫数量のみ回答、納品日は別途連絡」に方針変更

---

# End of Document
